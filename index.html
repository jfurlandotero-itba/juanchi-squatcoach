<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>PoseLandmarker - Video Demo</title>
    <style>
      body {
        background: #111;
        color: #eee;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      video, canvas {
        height: 640px;
        width: 360px;
        border-radius: 10px;
        margin-top: 10px;
      }
      button {
        margin-top: 15px;
        padding: 10px 20px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 2em;
      }
      button:hover {
        background: #45a049;
      }
    </style>
    <link rel="stylesheet" href="styles.css">
  </head>

  <body style="min-height: 100%;">
    <h1>Juanchi SquatCoach Demo<h1>

    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="videoUpload"><h4>Seleccionar video:</h4></label>
      <input type="file" id="videoUpload" accept="video/*" />
      <video id="video" controls playsinline></video>
      <canvas id="output"></canvas>
    </div>

    <div class="showOnResLoad", style="display: none;">
      <h5>Resultados:</h5>
      <div>
        <p id="error1" style="display: none;">Mirada</p>
        <p id="error2" style="display: none;">Espalda-Cuello</p>
        <p id="error3" style="display: none;">Profunda</p>
        <p id="error4" style="display: none;">Inclinacion</p>
        <p id="error5" style="display: none;">Manos-Hombros</p>
        <p id="error6" style="display: none;">Manos_Codos</p>
        <p id="error7" style="display: none;">Pendiente</p>
        <p id="error8" style="display: none;">Pies</p>
        <p id="error9" style="display: none;">Postura</p>
      </div>
    </div>

    <script type="module">
      import { FilesetResolver, PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const video = document.getElementById("video");
      const canvas = document.getElementById("output");
      const ctx = canvas.getContext("2d");

      let poseLandmarker = false;
      let lastVideoTime = -1;
      let running = false;
      const csvData = [];

      // Inicializar modelo
      async function init() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
          baseOptions: { modelAssetPath: "./pose_landmarker_lite.task" },
          runningMode: "VIDEO",
          numPoses: 1
        });
      }

      // Guardar landmarks en csvData
      function saveResultsToCSV(result) {
        if (!result || !result.landmarks) return;

        result.landmarks.forEach((landmarks, poseIndex) => {
          const row = [];
          row.push(video.currentTime.toFixed(3));
          row.push(poseIndex);

          landmarks.forEach(lm => {
            row.push(lm.x.toFixed(5));
            row.push(lm.y.toFixed(5));
            row.push(lm.z ? lm.z.toFixed(5) : 0);
            row.push(lm.visibility ? lm.visibility.toFixed(5) : 0);
          });

          csvData.push(row);
        });
      }
      video.addEventListener("ended", () => {
        console.log("Video finalizado. Enviando CSV al servidor...");
        fetchCSVData(csvData);
      });
      function fetchCSVData(csvData) {
        fetch('http://localhost:3002/api', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ data: csvData })
        })
        .then(response => response.json())
        .then(data => {
          console.log('Respuesta del servidor:', data);
          const els = document.querySelectorAll('.showOnResLoad');
          els.forEach(el => el.style.display = 'block');
          const arr = (data[0].vec_errores);
          arr.forEach((val, idx) => {
            const el = document.getElementById(`error${idx + 1}`);
            if (!el) return;
            el.style.display = val ? "inline" : "none";
          });
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }

      // Dibujar landmarks
      function drawResults(result) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (!result || !result.landmarks) return;

        saveResultsToCSV(result);

        for (const landmarks of result.landmarks) {
          for (const lm of landmarks) {
            ctx.beginPath();
            ctx.arc(lm.x * canvas.width, lm.y * canvas.height, 4, 0, 2 * Math.PI);
            ctx.fillStyle = "rgba(0, 255, 0, 0.8)";
            ctx.fill();
          }
        }
      }

      // Loop de detección
      function renderLoop() {
        if (video.paused || video.ended) {
          running = false;
          return;
        }

        if (video.videoWidth > 0 && video.videoHeight > 0 && video.currentTime !== lastVideoTime) {
          const results = poseLandmarker.detectForVideo(video, performance.now());
          drawResults(results);
          lastVideoTime = video.currentTime;
        }

        requestAnimationFrame(renderLoop);
      }

      // Descargar CSV acumulado
      const downloadBtn = document.createElement("button");
      downloadBtn.textContent = "Descargar CSV";
      document.body.appendChild(downloadBtn);

      downloadBtn.addEventListener("click", () => {
        if (!csvData.length) return alert("No hay datos para exportar.");

        let csvContent = "data:text/csv;charset=utf-8,";
        csvData.forEach(row => {
          csvContent += row.join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "pose_landmarks.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      // Iniciar detección automáticamente al reproducir
      video.addEventListener("loadeddata", () => {
        console.log(poseLandmarker, running);
        if (!poseLandmarker) return;
        if (running) return;
        running = true;
        renderLoop();
      });

      // Cargar video
      const upload = document.getElementById('videoUpload');
      upload.addEventListener('change', () => {
        const file = upload.files && upload.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        video.loop = false;
        video.src = url;
        video.load();
        video.play().catch(()=>{});
        video.addEventListener('loadeddata', () => URL.revokeObjectURL(url), { once: true });
      });

      init();
    </script>
  </body>
</html>
